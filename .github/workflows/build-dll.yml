name: Build UPSMonitorService DLL

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-dll:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Visual Studio environment
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: 'latest'

      - name: Compile Message Files
        shell: pwsh
        run: |
          # Navigate to resources directory
          cd ms-resources
   
          # Compile the .mc file to .h and .tl
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\mc.exe" /h UPSMonitorService.h /tl UPSMonitorService.tl UPSMonitorService.mc
          
          # Compile the .rc file to .res
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\rc.exe" UPSMonitorService.rc
          
          # Link the resource file into a DLL
          & "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64\link.exe" /DLL /OUT:UPSMonitorService.dll UPSMonitorService.res
          
          # Move the DLL to the desired output directory (e.g., `dist`)
          mkdir -Force ../dist
          Move-Item -Path UPSMonitorService.dll -Destination ../dist

      - name: Upload DLL Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UPSMonitorService-DLL
          path: dist/UPSMonitorService.dll